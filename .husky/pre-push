#!/bin/sh
# .husky/pre-push

echo "üîç Running static checks before push..."

# SECURITY: Check for .env files first (fast, critical)
if ! ./scripts/validation/check-no-env-files.sh; then
    echo ""
    echo "‚ùå SECURITY: .env files detected. Remove them before pushing."
    exit 1
fi

# Ensure repo skills mirror .claude skills before push.
if ! bun run sync:skills; then
    echo ""
    echo "‚ùå Failed to sync .claude/skills to .agents/skills."
    exit 1
fi

if ! git diff --quiet -- .agents/skills || ! git diff --cached --quiet -- .agents/skills; then
    echo ""
    echo "‚ùå .agents/skills changed during sync."
    echo "   Commit these updates before pushing:"
    echo "   git add .agents/skills && git commit -m \"sync agents skills\""
    exit 1
fi

if [ -n "$(git ls-files --others --exclude-standard -- .agents/skills)" ]; then
    echo ""
    echo "‚ùå Found untracked files in .agents/skills after sync."
    echo "   Commit these updates before pushing:"
    echo "   git add .agents/skills && git commit -m \"sync agents skills\""
    exit 1
fi

# Run comprehensive checks (no file rewrites):
# - Type checking (Turbo cached)
# - CI checks (Turbo cached): lint + format validation (no --write)
# - Core unit tests (web + tools)
if ! bun run static-check; then
    echo ""
    echo "‚ùå Pre-push check failed. Fix the issues above before pushing."
    echo "   Run 'bun run static-check' locally to verify fixes."
    echo "   To skip this check (not recommended): git push --no-verify"
    exit 1
fi

echo "‚úÖ All checks passed. Proceeding with push..."
