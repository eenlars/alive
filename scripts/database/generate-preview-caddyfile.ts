#!/usr/bin/env bun
/**
 * Generate preview subdomain Caddyfile blocks from existing domain→port mappings
 *
 * This script:
 * 1. Parses the main Caddyfile to extract domain→port mappings
 * 2. Generates corresponding preview subdomain blocks
 * 3. Outputs Caddyfile snippet to stdout (append manually or via script)
 *
 * Example output:
 *   protino-alive-best.preview.terminal.goalive.nl {
 *     reverse_proxy localhost:3357 {
 *       header_up Host localhost
 *     }
 *     header {
 *       -X-Frame-Options
 *       Content-Security-Policy "frame-ancestors https://dev.terminal.goalive.nl https://terminal.goalive.nl"
 *     }
 *     forward_auth https://dev.terminal.goalive.nl/api/auth/preview-guard
 *   }
 */

import { existsSync, readFileSync } from "node:fs"
import { dirname, resolve } from "node:path"
import { fileURLToPath } from "node:url"

// Get script directory and repo root
const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)
const REPO_ROOT = resolve(__dirname, "../..")

// Configurable paths via environment variables with repo-relative defaults
const CADDYFILE_PATH = process.env.CADDYFILE_PATH || resolve(REPO_ROOT, "ops/caddy/Caddyfile")
const ENV_CONFIG_PATH = process.env.ENV_CONFIG_PATH || resolve(REPO_ROOT, "packages/shared/environments.json")

const PREVIEW_BASE = "preview.terminal.goalive.nl"
const AUTH_ENDPOINT = "https://dev.terminal.goalive.nl/api/auth/preview-guard"

// Validate and read environments.json
if (!existsSync(ENV_CONFIG_PATH)) {
  console.error(`Error: environments.json not found at ${ENV_CONFIG_PATH}`)
  console.error("Set ENV_CONFIG_PATH environment variable or ensure file exists at default location")
  process.exit(1)
}

const envConfigRaw = JSON.parse(readFileSync(ENV_CONFIG_PATH, "utf-8"))
const production = envConfigRaw?.environments?.production
if (!production || typeof production.port !== "number") {
  console.error(`Error: environments.production.port must be defined and numeric in ${ENV_CONFIG_PATH}`)
  process.exit(1)
}
// Use production port for forward_auth since preview domains are accessed by production users
const AUTH_PORT = production.port

interface DomainMapping {
  domain: string
  port: number
}

/**
 * Parse Caddyfile to extract domain→port mappings
 */
function parseCaddyfile(content: string): DomainMapping[] {
  const mappings: DomainMapping[] = []

  // Regex to match domain blocks with reverse_proxy directives
  // Handles both single domains and comma-separated domains
  const domainBlockRegex = /^([a-zA-Z0-9.-]+(?:,\s*[a-zA-Z0-9.-]+)*)\s*\{[\s\S]*?reverse_proxy\s+localhost:(\d+)/gm

  for (const match of content.matchAll(domainBlockRegex)) {
    const domains = match[1].split(",").map(d => d.trim())
    const port = parseInt(match[2], 10)

    for (const domain of domains) {
      // Skip Claude Bridge itself and non-workspace domains
      if (domain.includes("terminal.goalive.nl") || domain.includes("staging.goalive.nl")) {
        continue
      }

      mappings.push({ domain, port })
    }
  }

  return mappings
}

/**
 * Convert domain to preview subdomain label
 * Examples:
 *   protino.alive.best → protino-alive-best
 *   demo.goalive.nl → demo-goalive-nl
 *
 * Note: Matches domainToPreviewLabel() in apps/web/lib/preview-utils.ts
 */
function domainToLabel(domain: string): string {
  return domain.replace(/\./g, "-")
}

/**
 * Generate preview subdomain block for a workspace
 */
function generatePreviewBlock(mapping: DomainMapping): string {
  const label = domainToLabel(mapping.domain)
  const previewHost = `${label}.${PREVIEW_BASE}`

  return `
${previewHost} {
    import image_serving

    reverse_proxy localhost:${mapping.port} {
        header_up Host localhost
    }

    header {
        # Security headers (embeddable variant)
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors https://dev.terminal.goalive.nl https://staging.terminal.goalive.nl https://terminal.goalive.nl https://app.alive.best"
        X-Content-Type-Options nosniff
        Referrer-Policy strict-origin-when-cross-origin
        -Server
        -X-Powered-By
    }

    # Auth check via forward_auth (passes query params for preview_token auth)
    forward_auth localhost:${AUTH_PORT} {
        uri /api/auth/preview-guard?{query}
        copy_headers Cookie
    }
}
`.trimStart()
}

/**
 * Generate complete preview section for Caddyfile
 */
function generatePreviewSection(mappings: DomainMapping[]): string {
  const blocks = mappings.map(generatePreviewBlock).join("\n")

  return `
# ============================================================================
# PREVIEW SUBDOMAINS (AUTO-GENERATED)
# ============================================================================
# This section is auto-generated by scripts/generate-preview-caddyfile.ts
# DO NOT EDIT MANUALLY - Changes will be overwritten
#
# Preview subdomains allow iframe embedding of workspace dev servers
# with proper authentication and security headers.
#
# Format: <workspace-label>.preview.terminal.goalive.nl → localhost:<port>
# Example: protino-alive-best.preview.terminal.goalive.nl → localhost:3357
#
# Features:
# - Host header set to "localhost" for Vite dev server compatibility
# - X-Frame-Options removed to allow iframe embedding
# - CSP frame-ancestors restricts to terminal.goalive.nl and app.alive.best
# - forward_auth enforces session authentication at Caddy edge
# ============================================================================

${blocks}
# ============================================================================
# END PREVIEW SUBDOMAINS (AUTO-GENERATED)
# ============================================================================
`.trimStart()
}

/**
 * Main execution
 */
function main() {
  // Show resolved paths for debugging
  console.error("Configuration:")
  console.error(`  Caddyfile: ${CADDYFILE_PATH}`)
  console.error(`  Environments: ${ENV_CONFIG_PATH}`)
  console.error(`  Auth port (production): ${AUTH_PORT}`)
  console.error("")

  // Check if Caddyfile exists
  if (!existsSync(CADDYFILE_PATH)) {
    console.error(`Error: Caddyfile not found at ${CADDYFILE_PATH}`)
    console.error("Set CADDYFILE_PATH environment variable or ensure file exists at default location")
    process.exit(1)
  }

  // Read and parse Caddyfile
  const content = readFileSync(CADDYFILE_PATH, "utf-8")
  const mappings = parseCaddyfile(content)

  if (mappings.length === 0) {
    console.error("Error: No domain→port mappings found in Caddyfile")
    process.exit(1)
  }

  console.error(`Found ${mappings.length} workspace domains`)

  // Generate preview section
  const previewSection = generatePreviewSection(mappings)

  // Output to stdout (can be piped or redirected)
  console.log(previewSection)

  console.error("\n✓ Preview Caddyfile blocks generated successfully")
  console.error("To append to Caddyfile, run:")
  console.error(`  bun run ${__filename} >> ${CADDYFILE_PATH}`)
  console.error("Then reload Caddy:")
  console.error("  systemctl reload caddy")
}

main()
