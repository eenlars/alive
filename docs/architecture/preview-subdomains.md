# Preview Subdomain Architecture

Production-ready iframe embedding solution for workspace dev servers using dedicated preview subdomains.

## Overview

Instead of proxying workspace content through Next.js (`/api/workspace-proxy`), we now use dedicated preview subdomains that connect directly to workspace dev servers. This eliminates content-mangling issues and provides proper Vite HMR functionality.

## Architecture

```
Browser (iframe in Sandbox.tsx)
  ↓
https://protino-alive-best.preview.terminal.alive.best/
  ↓
Caddy (forward_auth check)
  ↓
http://localhost:3357/ (workspace dev server)
```

## Components

### 1. DNS Configuration

**Wildcard DNS record:**
```
*.preview.terminal.alive.best → Server IP
```

This allows any `<label>.preview.terminal.alive.best` to resolve to the Caddy server.

### 2. Caddyfile Configuration

**Location:** `/root/alive/Caddyfile`

**Auto-generated section:**
```caddyfile
# ============================================================================
# PREVIEW SUBDOMAINS (AUTO-GENERATED)
# ============================================================================
# DO NOT EDIT MANUALLY - Changes will be overwritten
# Generated by scripts/generate-preview-caddyfile.ts

protino-alive-best.preview.terminal.alive.best {
    reverse_proxy localhost:3357 {
        header_up Host localhost
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }

    header {
        # Security headers (embeddable variant)
        -X-Frame-Options
        Content-Security-Policy "frame-ancestors https://dev.terminal.alive.best https://terminal.alive.best"
        X-Content-Type-Options nosniff
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin

        # Remove server identification
        -Server
        -X-Powered-By
    }

    # Auth check via forward_auth
    forward_auth dev.terminal.alive.best {
        uri /api/auth/preview-guard
        copy_headers Cookie
    }
}
```

**Key features:**
- **`header_up Host localhost`**: Makes Vite dev server happy (expects `localhost`)
- **No `X-Frame-Options`**: Allows iframe embedding
- **`Content-Security-Policy`**: Restricts embedding to terminal.alive.best domains only
- **`forward_auth`**: Enforces authentication at Caddy edge before proxying

### 3. Generation Script

**Location:** `/root/alive/scripts/generate-preview-caddyfile.ts`

**Purpose:**
- Parses existing Caddyfile to extract domain→port mappings
- Generates corresponding preview subdomain blocks
- Outputs to stdout for appending to Caddyfile

**Usage:**
```bash
# Regenerate preview blocks (overwrites existing section)
cd /root/alive
head -344 Caddyfile > Caddyfile.tmp && mv Caddyfile.tmp Caddyfile
bun run scripts/generate-preview-caddyfile.ts >> Caddyfile 2>/dev/null
systemctl reload caddy
```

### 4. Authentication Guard

**Location:** `/root/alive/apps/web/app/api/auth/preview-guard/route.ts`

**Purpose:**
- Validates session cookie before allowing access to preview subdomains
- Called by Caddy's `forward_auth` directive
- Returns 200 (authenticated) or 401 (unauthorized)

**Behavior:**
```typescript
GET /api/auth/preview-guard
  → Check session cookie exists
  → Return 200 if valid, 401 if missing/invalid
```

### 5. Sandbox Component Update

**Location:** `/root/alive/apps/web/features/chat/components/Sandbox.tsx`

**Changes:**
```typescript
// OLD (proxied through Next.js)
src={`/api/workspace-proxy/${workspace}/`}

// NEW (direct preview subdomain)
src={getPreviewUrl(workspace)}
// Example: https://protino-alive-best.preview.terminal.alive.best/
```

**Helper function:**
```typescript
function getPreviewUrl(workspace: string): string {
  const label = workspace.replace(/\./g, "-")
  return `https://${label}.preview.terminal.alive.best/`
}
```

**Domain conversion examples:**
- `protino.alive.best` → `protino-alive-best.preview.terminal.alive.best`
- `demo.alive.best` → `demo-alive-best.preview.terminal.alive.best`
- `kranazilie.nl` → `kranazilie-nl.preview.terminal.alive.best`

## Security Model

### Authentication Flow

```
1. User loads sandbox iframe
   ↓
2. Browser requests https://protino-alive-best.preview.terminal.alive.best/
   ↓
3. Caddy intercepts via forward_auth
   ↓
4. Caddy calls https://dev.terminal.alive.best/api/auth/preview-guard
   with Cookie header
   ↓
5. preview-guard checks session cookie
   ↓
6a. If valid: 200 → Caddy proxies to workspace
6b. If invalid: 401 → Caddy returns 401 to iframe
```

### Security Boundaries

1. **Authentication:** Session cookie validated at Caddy edge
2. **Embedding:** CSP `frame-ancestors` restricts to terminal.alive.best domains only
3. **Isolation:** Each workspace runs on separate port with systemd isolation
4. **Headers:** Production sites default to `X-Frame-Options: DENY`; template preview domains and explicit allowlisted hosts are exempted for deploy-ui iframe previews (allowlist: `ops/caddy/embeddable-hosts.txt`)

## Why This Works

### Vite Dev Server Requirements

Vite dev servers expect:
1. **Document origin = dev server origin**
2. **No path prefixes** (base must be `/`)
3. **WebSocket upgrades** for HMR

### What We Provide

1. ✅ **Document origin = preview subdomain** (which proxies to dev server)
2. ✅ **No path rewriting** (Caddy proxies transparently)
3. ✅ **WebSocket support** (Caddy handles upgrade headers)
4. ✅ **Host header = localhost** (Vite's allowedHosts setting)

### What We Eliminated

1. ❌ **No content mangling** (regex rewriting, URL interception)
2. ❌ **No runtime patches** (`window.vite_plugin_react_preamble_installed`)
3. ❌ **No proxy complexity** (Next.js middleware, response buffering)
4. ❌ **No CORS issues** (same-origin iframe)

## Lifecycle & Automation

### When New Workspace Created

**Option 1: Manual (current)**
```bash
cd /root/alive
./scripts/deploy-site-systemd.sh newsite.com
# Then regenerate preview blocks:
head -344 Caddyfile > Caddyfile.tmp && mv Caddyfile.tmp Caddyfile
bun run scripts/generate-preview-caddyfile.ts >> Caddyfile 2>/dev/null
systemctl reload caddy
```

**Option 2: Automated (future)**
- Integrate preview block generation into `deploy-site-systemd.sh`
- Script automatically updates Caddyfile and reloads Caddy
- Zero manual intervention

### Workspace Lifecycle

```
deploy-site-systemd.sh newsite.com
  ↓
1. Create workspace directory
2. Set up systemd service
3. Assign port (e.g., 3364)
4. Add to Caddyfile (production block)
5. [FUTURE] Generate preview block
6. [FUTURE] Reload Caddy
  ↓
Workspace accessible at:
- Production: https://newsite.com (X-Frame-Options: DENY by default)
- Preview: https://newsite-com.preview.terminal.alive.best (embeddable)
```

## Verification Checklist

To verify the preview architecture is working:

### 1. DNS Resolution
```bash
dig protino-alive-best.preview.terminal.alive.best
# Should resolve to server IP
```

### 2. Caddy Configuration
```bash
grep -A 20 "protino-alive-best.preview.terminal.alive.best" /root/alive/Caddyfile
# Should show preview block with forward_auth
```

### 3. Authentication Guard
```bash
curl -I http://localhost:8998/api/auth/preview-guard
# Should return 401 (no session)
```

### 4. Preview Access (with auth)
```bash
curl -I https://protino-alive-best.preview.terminal.alive.best/ \
  -H "Cookie: session=<valid-jwt>"
# Should return 200 with workspace content
```

### 5. Iframe Functionality
- Load https://dev.terminal.alive.best/chat
- Open Sandbox panel (if not visible: toggle debug mode)
- Select workspace "protino.alive.best"
- Verify:
  - ✅ Iframe loads without errors
  - ✅ No `/@react-refresh` errors in console
  - ✅ `window.vite_plugin_react_preamble_installed === true`
  - ✅ HMR websocket connected (check DevTools Network tab)
  - ✅ Hot updates apply when editing files

### 6. Security Headers
```bash
curl -I https://protino-alive-best.preview.terminal.alive.best/
# Should include:
# - Content-Security-Policy: frame-ancestors https://dev.terminal.alive.best https://terminal.alive.best
# - (no X-Frame-Options header)
```

## Troubleshooting

### Preview subdomain not resolving
**Check DNS:**
```bash
dig protino-alive-best.preview.terminal.alive.best
```
**Ensure wildcard record exists:** `*.preview.terminal.alive.best → Server IP`

### 401 Unauthorized in iframe
**Check authentication:**
- Ensure you're logged into Alive
- Check session cookie exists in DevTools (Application → Cookies)
- Verify preview-guard endpoint works: `curl -I http://localhost:8998/api/auth/preview-guard -H "Cookie: session=<jwt>"`

### 502 Bad Gateway
**Check workspace server:**
```bash
# Check if workspace is running
systemctl status site@protino-alive-best.service

# Check port mapping
grep "protino.alive.best" /root/alive/Caddyfile | grep reverse_proxy

# Test direct access
curl -I http://localhost:3357/
```

### Vite HMR not working
**Check WebSocket upgrade:**
```bash
# In DevTools Network tab, filter by "WS"
# Should see successful WebSocket connection to preview subdomain
```

**Check console for errors:**
```javascript
// Should NOT see:
// "Uncaught ReferenceError: __vite__cjsImport_1_react is not defined"

// Should see:
window.vite_plugin_react_preamble_installed === true
```

### Caddy reload fails
**Check Caddyfile syntax:**
```bash
caddy validate --config /root/alive/Caddyfile

# Common issues:
# - forward_auth URL must be scheme+host+port only (no path in URL)
# - Use "uri /path" subdirective instead
```

## Migration Path

### From Proxy to Preview Subdomains

**Before:**
```typescript
// Sandbox.tsx
<iframe src={`/api/workspace-proxy/${workspace}/`} />
```

**After:**
```typescript
// Sandbox.tsx
<iframe src={getPreviewUrl(workspace)} />
// https://protino-alive-best.preview.terminal.alive.best/
```

**Removed components:**
- `/api/workspace-proxy/[workspace]/[[...path]]/route.ts` (deleted)
- `/lib/workspace-ports.ts` (deleted - no longer needed)

## Future Enhancements

### 1. Automated Preview Block Generation
Integrate into `deploy-site-systemd.sh`:
```bash
# After creating workspace
generate-preview-caddyfile.ts --append
systemctl reload caddy
```

### 2. Token-Based Authentication
For additional security, generate short-lived tokens:
```typescript
// Generate signed token
const token = await generatePreviewToken(workspace, userId)
// https://protino-alive-best.preview.terminal.alive.best/?token=<jwt>

// Validate in preview-guard
const isValid = await verifyPreviewToken(token)
```

### 3. Preview-Specific Vite Config
Add shared Vite plugin for preview-specific settings:
```typescript
// packages/template/user/vite.config.ts
export default defineConfig({
  plugins: [
    react(),
    previewPlugin(), // Custom plugin for preview subdomain features
  ],
})
```

### 4. Console Integration
Connect workspace server logs to Sandbox console tab:
```typescript
// Stream systemd logs to Sandbox
useEffect(() => {
  const ws = new WebSocket('wss://protino-alive-best.preview.terminal.alive.best/__logs')
  ws.onmessage = (event) => {
    addEntry({ type: 'log', message: event.data })
  }
}, [workspace])
```

## References

- **Caddyfile:** `/root/alive/Caddyfile`
- **Generation script:** `/root/alive/scripts/generate-preview-caddyfile.ts`
- **Auth guard:** `/root/alive/apps/web/app/api/auth/preview-guard/route.ts`
- **Sandbox component:** `/root/alive/apps/web/features/chat/components/Sandbox.tsx`
- **Main docs:** `/root/alive/README.md`
