# Nginx SNI Router - Routes TLS traffic based on SNI to appropriate Caddy instance
# This solves the SO_REUSEPORT conflict between caddy.service and caddy-shell.service
#
# Architecture:
#   nginx (port 443) -> SNI routing -> caddy-shell (8443) for shell domains
#                                   -> caddy-main (8444) for everything else
#
# See: /root/webalive/claude-bridge/docs/architecture/nginx-sni-router.md

user www-data;
worker_processes auto;
pid /run/nginx.pid;
error_log /var/log/nginx/error.log;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 4096;
}

# Stream module for TCP/TLS SNI routing (Layer 4)
stream {
    # Log format for debugging SNI routing
    log_format stream_routing '$remote_addr [$time_local] '
                              'SNI: $ssl_preread_server_name -> $backend '
                              '$protocol $status $bytes_sent $bytes_received '
                              '$session_time';

    access_log /var/log/nginx/stream_access.log stream_routing;

    # Map SNI hostname to backend
    # Shell domains -> caddy-shell (isolated for long-lived SSE connections)
    # Everything else -> caddy-main
    map $ssl_preread_server_name $backend {
        # Go Shell domain - route to caddy-shell for SSE isolation
        go.goalive.nl               caddy_shell;

        # Default: all other domains go to main Caddy
        default                     caddy_main;
    }

    # Upstream: Main Caddy instance (handles all websites, APIs, etc.)
    upstream caddy_main {
        server 127.0.0.1:8444;
    }

    # Upstream: Shell Caddy instance (isolated, rarely reloaded)
    upstream caddy_shell {
        server 127.0.0.1:8443;
    }

    # HTTPS listener - SNI-based routing with TLS passthrough
    server {
        listen 443;
        listen [::]:443;

        # Enable SNI inspection (reads TLS ClientHello without terminating)
        ssl_preread on;

        # Route to appropriate backend based on SNI
        proxy_pass $backend;

        # Timeouts for long-lived connections (SSE, WebSocket)
        proxy_connect_timeout 10s;
        proxy_timeout 24h;  # Allow very long SSE connections
    }

    # HTTP listener - proxy to main Caddy (handles HTTP->HTTPS redirects)
    server {
        listen 80;
        listen [::]:80;

        # All HTTP goes to main Caddy (it handles redirects)
        proxy_pass caddy_main_http;
        proxy_connect_timeout 10s;
        proxy_timeout 300s;
    }

    # HTTP upstream (port 8081 for main Caddy)
    upstream caddy_main_http {
        server 127.0.0.1:8081;
    }
}

# HTTP block - minimal, only for status endpoint
http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Status endpoint for monitoring
    server {
        listen 127.0.0.1:8888;

        location /nginx-status {
            stub_status on;
            allow 127.0.0.1;
            deny all;
        }

        location / {
            return 200 "nginx SNI router is running\n";
            add_header Content-Type text/plain;
        }
    }
}
